# 图库：缓存、更新与置顶（功能需求文档）

状态：通过，进入实现（MVP）
归属：Web 前端（Next.js）
最后更新：YYYY-MM-DD

## 1. 概述
首页展示全局最新图片与其对应 emoji（1:1）。目标是：首屏快速可见、减少重复拉取、并在用户创作期间让其新作品在顶部置顶一段时间，提升创作反馈体验。

## 2. 目标与范围
- 首次加载展示 12 条。
- 点击“加载更多”每次追加 4 条（不做滚动加载）。
- 仅关注“最新前 12 条是否变化”，更旧历史不做实时一致性维护。
- 本机新生成的图片在“创作活跃窗口”内置顶展示。
- 本地缓存以减少无效请求；总缓存量：12（首屏）+ 4（第一页更多）= 16 条。
- 每 3 分钟后台检查是否有更新（无需强一致）。

非目标（MVP）：
- 不提供“同步最新”按钮；不启用强一致阻塞模式。
- 暂不依赖 ETag/If-None-Match 与 CDN 内容哈希（后续优化）。
- 不做实时推送；3 分钟轮询足够。

## 3. 关键行为
- 置顶窗口（创作活跃）：默认 3 分钟。
  - 只要出现“新一次本地生成”或“占位 → 确认”的状态变化，即重置 3 分钟计时。
  - 置顶期间：UI 一直将置顶项放在最前，不被远端更新覆盖。
  - 置顶容量：不做上限限制；若置顶数 > 12，则首屏可能全被置顶占满。
  - 并发限制：同一时间最多 1 个生成任务。
- 占位卡片（placeholder）：
  - 生成中，在顶部插入 1 张占位卡片并显示 loading；该卡片计入首屏 12 条。
  - 成功：占位转为正式记录，并继续置顶到窗口结束。
  - 失败/取消：移除占位卡片，弹一次性错误 toast。
- 后台刷新：每 3 分钟（以及页面回前台/网络恢复）拉取最新 12 条。
  - 置顶期间：不覆盖 UI，仅更新本地缓存，并在组件右侧小字提示。
  - 非置顶：立即用最新 12 条替换 UI 并更新缓存。

## 4. 数据模型（客户端）
Item 字段（最小集）：
- id: string
- createdAt: ISO 时间戳
- updatedAt: ISO 时间戳
- imageUrl: string（MVP 为普通 URL；后续可换内容哈希 URL）
- thumbUrl: string（优先 WebP/AVIF）
- emoji: string

客户端状态：
- pinned：置顶集合（内存/会话），含占位与确认后的本地项。
- pinWindowUntil：当前 3 分钟置顶窗口的截止时间戳。
- top12：权威快照（持久化）。
- page1（更多 4 条）：第一页更旧内容（持久化）。
- cursor：分页游标（仅用于“更多 4 条”，超过第一页不持久化）。
- lastSyncAt：最后一次后台拉取成功时间。

## 5. API 契约（MVP）
- GET /gallery?limit=12 → 按 createdAt 降序的最新 12 条
  - Response: { items: Item[] }
- GET /gallery?limit=4&after=<cursor> → 下一批更旧的 4 条
  - Response: { items: Item[], nextCursor?: string }

说明：
- cursor 建议基于 createdAt + id 的稳定排序。
- 响应仅包含最小字段集合。

## 6. 缓存与存储分层
- 第 0 层（内存）：当前渲染列表、置顶集合、cursor、pinWindowUntil。
- 第 1 层（会话）：sessionStorage 持久化置顶集合与 pinWindowUntil（仅本标签页）。
- 第 2 层（持久）：IndexedDB 持久化 top12（12 条）、page1（4 条）、lastSyncAt。
- 第 3 层（图片）：暂用浏览器 HTTP 缓存（后续再接入 CDN + 内容哈希 + immutable）。

容量：
- 持久化总量 ≤ 16 条（12 + 4）。page1 之外的更多页不持久化。

## 7. 渲染与合并规则
- 渲染源 = pinned（会话） + top12（持久）。
- 以 id 去重；若 pinned 与 top12 同 id，优先使用 pinned。
- 合并后按 createdAt 降序排序，首屏取前 12 条。
- 占位卡片永远置于最前，且计入 12 条。
- “加载更多”在底部追加 4 条；置顶仅影响首屏排序。

## 8. 后台刷新规则
- 每 3 分钟拉取最新 12 条。
- 置顶期间：仅更新 IndexedDB 的 top12，并在右侧小字提示“发现新内容，将在你停止生成后自动更新”，不改动 UI 列表。
- 非置顶：直接用最新 top12 替换 UI 并更新 IndexedDB。
- 页面回前台或网络恢复：与心跳同逻辑执行一次检查。

## 9. 错误与离线
- 离线：若有持久缓存则直接渲染；否则显示骨架与错误提示。
- 拉取失败：保留当前 UI，不清空缓存；等待下次心跳/触发重试。
- 生成失败/取消：移除占位卡片，弹出一次性 toast “生成失败，请重试”。

## 10. 时序图要点（关键步骤）
参与者：用户、Gallery 组件、SessionStorage、IndexedDB、API、心跳定时器。

A）首次进入
1）读取 IndexedDB 的 top12 + page1 及 SessionStorage 的 pinned/pinWindowUntil。
2）合并渲染（pinned + top12）取前 12；若有占位则置前。
3）异步请求 /gallery?limit=12：
   - 无置顶 → 立即替换 UI 并落库。
   - 有置顶 → 仅落库并右侧提示，不改 UI。

B）开始生成（单任务）
1）顶部插入占位卡片；禁用 Pixelate Now。
2）设置/续期 pinWindowUntil = now + 3 分钟。
3）成功 → 占位转正式，续期 3 分钟。
4）失败/取消 → 删除占位，弹一次性错误 toast，恢复按钮可点击。

C）心跳（每 3 分钟）
1）请求 /gallery?limit=12。
2）置顶中 → 仅落库并提示。
3）非置顶 → 替换 UI 并落库；清理提示。

D）置顶到期
1）连续 3 分钟无新生成/状态变化 → 置顶结束。
2）若本地缓存存在更新的 top12 → 应用到 UI，并清空置顶集合。

E）加载更多（+4）
1）请求 /gallery?limit=4&after=<cursor>。
2）在底部追加 4 条；持久化为 page1；更新 cursor。
3）只保留 page1，淘汰更旧页缓存。

F）前台/联网
1）触发与心跳同逻辑的一次检查。

## 11. 实现清单（Implementation Checklist）
前端（Next.js/React）：
- 状态与存储
  - 置顶集合（内存 + sessionStorage）与 pinWindowUntil。
  - IndexedDB DAO：top12（12）/page1（4）/lastSyncAt。
  - 游标管理（+4 分页）。
- 渲染
  - 合并 pinned + top12；按 id 去重；按时间降序取 12。
  - 占位卡片组件（loading，计入 12）。
  - “加载更多”按钮在底部追加 4 条。
  - 右侧小字提示：置顶期间检测到更新。
- 网络
  - 拉取最新 12；基于 cursor 拉取更旧 4；仅最小字段。
  - 心跳 3 分钟；前台/联网事件同逻辑。
  - 错误处理：生成失败 toast；拉取失败保留 UI。
- 生成流程
  - 强制单任务；生成中禁用 Pixelate Now。
  - 插入占位；成功转正式；失败移除。
  - 新生成/状态变化续期置顶窗口。
- 离线/骨架
  - 离线用缓存；无缓存显示骨架。

后端/API：
- 提供接口：
  - GET /gallery?limit=12 → 最新 12（createdAt desc）。
  - GET /gallery?limit=4&after=<cursor> → 更旧 4 + nextCursor（createdAt+id 稳定排序）。
- 字段最小集：id, createdAt, updatedAt, imageUrl, thumbUrl, emoji。
- 光标稳定性保证。

可观测性（可选）：
- 记录心跳成功/失败、缓存命中率、占位可见时长、提示曝光率。

## 12. 未来优化（不含于 MVP）
- 顶部 12 集合的 ETag/If-None-Match，节省带宽。
- 图片 URL 内容哈希 + CDN immutable 长缓存。
- 空闲时预取下一页缩略图。
- SSE/WebSocket 推送“有更新”信号（置顶期仍延后应用）。

## 13. 边界情况
- 置顶数 > 12：首屏可能只有置顶项；“加载更多”仍在列表底部追加 4 条（顺序不受置顶影响）。
- 长时创作：持续生成会不断续期置顶窗口；只有在 3 分钟无活动后才切回全局最新。
- 重复 id：置顶期以置顶为准；置顶结束后由权威 top12 取代 UI。
